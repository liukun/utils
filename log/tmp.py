files = ['activity.2012-02-25.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-02-25.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-02-26.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-02-26.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-02-27.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-02-27.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-02-28.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-02-28.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-02-29.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-02-29.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-01.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-01.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-02.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-02.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-03.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-03.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-04.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-04.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-05.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-05.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-06.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-06.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-06.us-east-1.ip-10-112-249-27.log.bz2', 'activity.2012-03-06.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-07.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-07.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-07.us-east-1.ip-10-112-249-27.log.bz2', 'activity.2012-03-07.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-08.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-08.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-08.us-east-1.ip-10-112-249-27.log.bz2', 'activity.2012-03-08.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-09.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-09.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-09.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-10.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-10.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-10.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-11.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-11.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-11.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-12.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-12.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-12.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-13.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-13.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-13.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-14.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-14.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-14.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-15.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-15.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-15.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-16.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-16.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-16.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-17.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-17.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-17.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-18.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-18.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-18.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-19.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-19.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-19.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-20.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-20.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-20.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-21.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-21.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-21.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-22.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-22.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-22.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-23.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-23.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-23.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-24.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-24.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-24.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-25.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-25.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-25.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-26.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-26.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-26.us-east-1.ip-10-212-178-114.log.bz2', 'activity.2012-03-27.ap-northeast-1.ip-10-154-21-236.log.bz2', 'activity.2012-03-27.ap-northeast-1.ip-10-154-23-205.log.bz2', 'activity.2012-03-27.us-east-1.ip-10-212-178-114.log.bz2']

last_date = None
last_region = None
batch = []

import sys
from operator import itemgetter

def batch_process(files, date, region):
    if not files: return
    if not date or not region:
        print ' skipped', files
        del files[:]
        return
    if len(files) < 2: return
    need = False
    for parser in parsers:
        parser.new_csv(date, region)
        if parser.csv:
            need = True
    if not need: return
    if DEBUG: print ' processing', files
    opens = []
    for f in files:
        opens.append(bz2.BZ2File(os.path.join(root, name)))
    lines = []
    for f in opens:
        try:
            lines.append(f.next())
        except StopIteration:
            pass
    while lines:
        # find most early line of log
        index, line = min(enumerate(lines), key=itemgetter(1))
        print line
        #for parser in parsers:
        #    parser.parse(line)
        try:
            next = opens[index].next()
            lines[index] = next
        except StopIteration:
            del lines[index]
            opens[index].close()
            del opens[index]
    del files[:]
    sys.exit(0)

while files:
    f = files.pop(0)
    # f == 'activity.2012-03-26.us-east-1.ip-10-212-178-114.log.bz2'
    parts = f.split('.')
    if parts[-1] != 'bz2': continue
    if (last_date != parts[1] or last_region != parts[2]):
        batch_process(batch, last_date, last_region)
        last_date = parts[1]
        last_region = parts[2]
    batch.append(f)
batch_process(batch, last_date, last_region)
